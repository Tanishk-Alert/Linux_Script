pipeline {
    agent {
        label 'linux_deploy_us || linux_deploy_india'
    }

    /* ================= PARAMETERS ================= */
    parameters {
        string(name: 'gitBranch', defaultValue: '', description: 'Git branch')
        string(name: 'buildVersion', defaultValue: '', description: 'Build version')
        string(name: 'IP', defaultValue: '', description: 'Linux VM IP')
        string(
            name: 'artifacts',
            defaultValue: 'application',
            description: 'Artifacts to deploy (application,agent)'
        )
        booleanParam(
            name: 'flywayFixed',
            defaultValue: false,
            description: 'Run only Flyway migrations'
        )
    }

    /* ================= ENVIRONMENT ================= */
    environment {
        AWS_CREDS   = credentials('AWS')        // AWS credentials ID
        GIT_TOKEN   = credentials('GIT_TOKEN')  // Git token ID
        S3_SRC_PATH = 's3://aehscbuilds'
    }

    stages {

        /* ================= VALIDATION ================= */
        stage('Validation') {
            steps {
                script {
                    if (!params.gitBranch?.trim())    error 'gitBranch is required'
                    if (!params.buildVersion?.trim()) error 'buildVersion is required'
                    if (!params.IP?.trim())           error 'IP is required'
                    if (!params.artifacts?.trim())    error 'artifacts is required'
                }
            }
        }

        /* ================= INIT ================= */
        stage('Init') {
            steps {
                script {
                    env.AWS_ACCESS_KEY_ID     = env.AWS_CREDS_USR
                    env.AWS_SECRET_ACCESS_KEY = env.AWS_CREDS_PSW
                }
            }
        }

        /* ================= INFO ================= */
        stage('All Info') {
            steps {
                sh '''
                echo "=============================="
                echo "Git Branch    : $gitBranch"
                echo "Build Version : $buildVersion"
                echo "VM IP         : $IP"
                echo "Artifacts     : $artifacts"
                echo "Flyway Only   : $flywayFixed"
                echo "=============================="
                '''
            }
        }


         /* ================= ASSUME ROLE ================= */
        stage('Assume Role (STS)') {
            steps {
                script {
                    def json = sh(
                        script: """
aws sts assume-role \
  --role-arn arn:aws:iam::421493212608:role/JenkinsS3AccessRole \
  --role-session-name jenkins-${BUILD_NUMBER} \
  --duration-seconds 900 \
  --output json
""",
                        returnStdout: true
                    ).trim()

                    def creds = readJSON text: json

                    env.AWS_ACCESS_KEY_ID     = creds.Credentials.AccessKeyId
                    env.AWS_SECRET_ACCESS_KEY = creds.Credentials.SecretAccessKey
                    env.AWS_SESSION_TOKEN     = creds.Credentials.SessionToken
                }
            }
        }

       

        /* ================= DEPLOY ================= */
        stage('Deploy on VM') {
            steps {
                withCredentials([
                    sshUserPrivateKey(
                        credentialsId: 'local_linux_vms',
                        keyFileVariable: 'SSH_KEY',
                        usernameVariable: 'SSH_USER'
                    )
                ]) {
                    sh """
ssh -i "${SSH_KEY}" -o StrictHostKeyChecking=no ${SSH_USER}@${IP} << 'EOF'
sudo bash << 'INNER_EOF'
set -e

# ---------------- SECURITY HARDENING ----------------
unset HISTFILE
export HISTSIZE=0
export HISTFILESIZE=0
set +o history

cleanup() {
    unset AWS_ACCESS_KEY_ID
    unset AWS_SECRET_ACCESS_KEY
    unset GIT_TOKEN
}
trap cleanup EXIT

# ---------------- AWS CREDENTIALS ----------------
export AWS_ACCESS_KEY_ID="$AWS_ACCESS_KEY_ID"
export AWS_SECRET_ACCESS_KEY="$AWS_SECRET_ACCESS_KEY"
export AWS_SESSION_TOKEN="$AWS_SESSION_TOKEN"

# ---------------- DEPLOY ----------------
rm -rf /tmp/scripts

git clone https://${GIT_TOKEN}@github.com/Tanishk-Alert/Linux_Script.git /tmp/scripts

bash /tmp/scripts/deployScript/deploy.sh \
    "${S3_SRC_PATH}" \
    "${gitBranch}" \
    "${buildVersion}" \
    "${flywayFixed}" \ 
    ""${artifacts}" 
INNER_EOF
EOF
"""
                }
            }
        }
    }

    post {
        success {
            echo 'ðŸŽ‰ Deployment successful'
        }
        failure {
            echo 'âŒ Deployment failed'
        }
        always {
            cleanWs()
        }
    }
}
